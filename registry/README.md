# Registry

Данный сервис принимает запросы от пользователя.
Каждый запрос записывается в базу.

API оформленно в виде swagger.

[Swagger http://localhost/swagger/index.html](http://localhost/swagger/index.html)

## Flow
При первом запросе сервис создает пользователя и начисляет ему бонусные баллы на счет.

**Как проходит обработка заказа:**

1. Заказ записывается в базу данных со статусом. `ORDER_PENDING`
2. Отправляется сообщение в топик `storage-reserve-order` и ждем ответ из `storage-reserve-order-response` (асинхронно)
   - `storage` делает резервирование и отправляет результат в `storage-reserve-order-response`
3. При успешном резервировании на стороне storage заказ меняет статус на ORDER_RESERVED, обновляем стоимость заказа. 
 После отправляется сообщение в топик `wallet-pay-order` и ждем ответ из `wallet-pay-order-response` (асинхронно)
 При ошибке резервирования заказ отменяется и ему изменяется статус на `ORDER_ERROR`.
   - `wallet` проводит оплату и отправляет результат в `wallet-pay-order-response`
4. При успешной оплате на стороне `wallet` заказ меняет статус на `ORDER_PAID`. 
 Если вернулась ошибка. То запускается компенсирующая цепочка: отправляется сообщение в топик `storage-cancel-order`.
   - `storage` отменяет зарезервированные товары для заказа и возвращает их в общий пул.
   - `storage` отправляет результат в топик `storage-cancel-order`.
5. При успешном отмене заказа, его статус меняется на `ORDER_CANCELED`, иначе `ORDER_CANCELLATION_ERROR`.

## Пример заказа в swagger

```json
{
  "uid": "61f56631de878e222366375b",
  "items": [
    {
      "name": "A",
      "quantity": 2
    }
  ]
}
```

> `uid` можно узнать из заголовка ответа с названием `x-uid`