# Wallet

Данный сервис отвечает за операции с финансами. Списание и возврат денег на счету.

## Описание

### Flow

Сервис получает сообщение из топика `wallet-pay-order` на оплату заказа и списывает сумму заказа с пользовательского счета.

Если на счету нет необходимой суммы, то в топик с результатом `wallet-pay-order-response` отправляется сообщение об ошибке. 
Статус записывается в заголовки сообщения.

### Транзакции

Операции по счету хранятся в виде транзакций по счету.

**Формат хранения счета:**

```json
{
  "user_id": {
    "$oid": "61f82c87bb0a64f99f1cddf3"
  },
  "user_name": "",
  "balance": 94,
  "transactions": [
    {
      "order_id": {
        "$oid": "61f82c87bb0a64f99f1cddf3"
      },
      "status": "TRANSACTION_ACTIVE",
      "amount": 100,
      "balance": 100,
      "note": "New Customer Bonus",
      "timestamp": {
        "$date": "2022-01-31T18:39:30.287Z"
      }
    },
    {
      "order_id": {
        "$oid": "61f82d15bb0a64f99f1cddf8"
      },
      "status": "TRANSACTION_ACTIVE",
      "amount": -6,
      "balance": 94,
      "note": "Order payment",
      "timestamp": {
        "$date": "2022-01-31T18:40:39.933Z"
      }
    }
  ]
}
```

Транзакции имеют два статуса: `TRANSACTION_ACTIVE` и `TRANSACTION_CANCELLED`.
Транзакции не удаляются, но могут изменить статус.
Для отмененной транзакции создается транзакция компенсирующая ее, а статус отмененной меняется.

### Создание счета

Так же данный сервис создаёт счета для новых пользователей. 
Для этого сервис получает сообщения из топика `wallet-create`.
В сообщение передается идентификатор нового пользователя и если для этого идентификатора не создан счет, то будет создан новый.
Предполагается, что каждый пользователь имеет единственный счет. У созданного счета указывается идентификатор пользователя.

**Формат сообщения создания счета:**
```json
{
  "id": "61f82c87bb0a64f99f1cddf3"
}
```

Когда создаётся счёт, записывается первая транзакция, где начисляются бонусные 100 единиц для новых пользователей.
